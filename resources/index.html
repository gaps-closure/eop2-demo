<html>
<head>
  <title>CLOSURE Demo</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="styles.css" type="text/css">
</head>

<body>
  <header>
    <h1><a href="index.html">CLOSURE Demo</a></h1>
    <!-- <p>Send video frames using a websocket</p> -->
  </header>
  <!--  <form onsubmit="return false;"> -->
  <!--   <input type="text" name="message" value="Hello, World!"/> -->
  <!--    <input type="button" value="Send Web Socket Data" onclick="send(this.form.message.value)"/> -->
  <!--  </form> -->
  
  <!--  <label id="label-view">Not Viewing</label>  -->
  <!--  <button onclick="connect()">Connect</button> -->
  <!--  <button onclick="disconnect()">Disconnect</button> -->
  
  <main>
    <!-- <button>Start streaming</button> -->
        <input type="button" value="Connect"  id="btn" />
    <div class="row">
      <figure>
        <canvas id="decoded" width="640" height="360"></canvas><br />
        <figcaption id="caption">Live View <span id="websocket-latency"></span></figcaption >
      </figure>
    </div>
  </main>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
  <script async src="js/opencv.js"></script>
  
<script>
		const decoded = document.querySelector("#decoded");
		const dCtx = decoded.getContext('2d');

    var socket;

    //const label = document.getElementById("label-view");
    const caption = document.getElementById("caption");
    
    const btn = document.getElementById("btn");
    
    btn.addEventListener("click", () => {
        if (btn.value === "Connect") {
            btn.value = "Disconnect";
            caption.innerHTML = "Live View";
            //btn.style.background='#00ff00';
            connect();
        }
        else {
            btn.value= "Connect";
            caption.innerHTML = "View Stopped";
            // btn.style.background='#ff0000';
            disconnect();
        }
    })
    
    async function renderImage(ctx, blob) {
      var buf = await blob.arrayBuffer();
    	var array = new Uint8ClampedArray(buf);

    	let mat = cv.matFromArray(480, 640, cv.CV_8UC3, array);
    	cv.imshow('decoded', mat);
    }
    
    function send(message) {
        if (!window.WebSocket) {
            return;
        }
        if (socket.readyState == WebSocket.OPEN) {
            socket.send(message);
        } else {
            alert("The socket is not open.");
        }
    }
    
    function connect() {
        if (window.WebSocket) {
            socket = new WebSocket("ws://localhost:8080/video");
            socket.onmessage = function(m) {
            	  // console.log("Received data from websocket: " + m.data);
            	
                let blob = m.data;
                renderImage(dCtx, blob);
            };
            socket.onopen = function(event) {
                console.log("Web Socket opened!");
            };
            socket.onclose = function(event) {
            	console.log("Web Socket closed.");
            };
        } else {
            alert("Your browser does not support Websockets. (Use Chrome)");
        }
    }
    
    function disconnect() {
    	  socket.close();
    	  console.log("client close socket");
    }
</script>

</body>
</html>