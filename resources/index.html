<!--

  This example adapted from Netty project

 * Copyright 2010 Red Hat, Inc.
 *
 * Red Hat licenses this file to you under the Apache License, version 2.0
 * (the "License"); you may not use this file except in compliance with the
 * License.  You may obtain a copy of the License at:
 *
 *    http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the
 * License for the specific language governing permissions and limitations
 * under the License.
 *
 -->

<html>
<head>
  <title>CLOSURE Demo</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="styles.css" type="text/css">
</head>
<body>
  <header>
    <h1><a href="index.html">CLOSURE Demo</a></h1>
    <!-- <p>Send video frames using a websocket</p> -->
  </header>
  <form onsubmit="return false;">
    <input type="text" name="message" value="Hello, World!"/>
    <input type="button" value="Send Web Socket Data" onclick="send(this.form.message.value)"/>
  </form>
  
  <input type="button" value="Connect"  id="btn" />
  <!--  <button onclick="connect()">Connect</button> -->
  <!--  <button onclick="disconnect()">Disconnect</button> -->
  <main>
    <!-- <button>Start streaming</button> -->
    <div class="row">
      <figure>
        <canvas id="decoded" width="640" height="360"></canvas><br />
        <caption>websocket <span id="websocket-latency"></span></caption>
      </figure>
    </div>
  </main>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
  <script async src="js/opencv.js"></script>
<script>
		const decoded = document.querySelector("#decoded");
		const dCtx = decoded.getContext('2d');

    var socket;

    const btn = document.getElementById("btn");
    btn.addEventListener("click", () => {
        if (btn.value === "Connect") {
            btn.value = "Disconnect";
            connect();
        }
        else {
            btn.value= "Connect";
            disconnect();
        }
    })
    
    async function renderImage(ctx, blob) {
      var buf;
    	(async () => {
    		  buf = await blob.arrayBuffer();
    		  console.log( "------- " + buf.byteLength ); // 5
    		  
    		  var view = new DataView(buf);
    		  console.log(view.getUint8(0) + " " + view.getUint8(1));
    		  
    		  var array = new Uint8ClampedArray(buf);

    		  //var image = new ImageData(array, 640, 480);
    		  //decoded.putImageData(image, 0, 0);
    		  
    	      let mat = cv.matFromArray(480, 640, cv.CV_8UC3, array);
    	      cv.imshow('decoded', mat);
    		  
    		})();
    	
//      const bmp = await createImageBitmap(blob);
//      ctx.drawImage(bmp, 0, 0);
//      bmp.close();
      //console.log("rendering");
      //let mat = new cv.Mat([480, 640], cv.CV_8UC3);
      
      // We read the loaded image from imgElement and save it in a variable
      // we could modify later with OpenCV functions 
      //let mat = cv.imread(blob);
  //let mat = new cv.Mat(480, 640, cv.CV_8UC3);
//  let mat = cv.matFromArray(480, 640, cv.CV_8UC3, buf);
      
      //let ctx = canvas.getContext("2d");
      //let imgData = ctx.getImageData(0, 0, 480, 640);
      //let mat = cv.matFromImageData(blob);
      
      //console.log("read..............." + blob.size);
      // We print the saved or modified image to the canvas element with id 'decode' 
  //    cv.imshow('decoded', mat);
    }
    
    function send(message) {
        if (!window.WebSocket) {
            return;
        }
        if (socket.readyState == WebSocket.OPEN) {
            socket.send(message);
        } else {
            alert("The socket is not open.");
        }
    }
    
    function connect() {
        if (window.WebSocket) {
            socket = new WebSocket("ws://localhost:8080/video");
            socket.onmessage = function(m) {
            	  console.log("Received data from websocket: " + m.data);
            	
                let blob = m.data;
                renderImage(dCtx, blob);
                //fake();
            };
            socket.onopen = function(event) {
                console.log("Web Socket opened!");
            };
            socket.onclose = function(event) {
            	console.log("Web Socket closed.");
            };
        } else {
            alert("Your browser does not support Websockets. (Use Chrome)");
        }
    }
    
    function disconnect() {
    	  socket.close();
    	  console.log("client close socket");
    }
</script>

</body>
</html>